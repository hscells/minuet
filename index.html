<DOCTYPE html/>
<html>
<head>
    <title>unnamed music playing bot</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <!-- polyfill -->
    <script src="/static/inc/shim/Base64.js" type="text/javascript"></script>
    <script src="/static/inc/shim/Base64binary.js" type="text/javascript"></script>
    <script src="/static/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
    <!-- midi.js package -->
    <script src="/static/js/midi/audioDetect.js" type="text/javascript"></script>
    <script src="/static/js/midi/gm.js" type="text/javascript"></script>
    <script src="/static/js/midi/loader.js" type="text/javascript"></script>
    <script src="/static/js/midi/plugin.audiotag.js" type="text/javascript"></script>
    <script src="/static/js/midi/plugin.webaudio.js" type="text/javascript"></script>
    <script src="/static/js/midi/plugin.webmidi.js" type="text/javascript"></script>
    <!-- utils -->
    <script src="/static/js/util/dom_request_xhr.js" type="text/javascript"></script>
    <script src="/static/js/util/dom_request_script.js" type="text/javascript"></script>
</head>
<body>
<div id="bar-id"></div>
<div id="playing"></div>
<script>
    window.onload = function() {
        var barEl = document.getElementById("bar-id");
        var noteEl = document.getElementById("playing");

        MIDI.loadPlugin({
            soundfontUrl: "/static/soundfont/",
            instrument: "acoustic_grand_piano",
            onprogress: function(state, progress) {
                console.log(state, progress);
            },
            onsuccess: function() {
                conduct()
            }
        });

        var conduct = function() {
            getBar(function(bar) {
                playBar(bar)
            });
        };

        var getBar = function(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("get", "/bar", true);
            xhr.responseType = "json";
            xhr.onload = function() {
                var status = xhr.status;
                if (status == 200) {
                    callback(xhr.response)
                }
            };
            xhr.send();
        };

        var playBar = function(bar) {

            barEl.innerText = bar["id"];
            for (var i = 0; i < bar["notes"].length; i++) {
                var note = bar["notes"][i];
                window.setTimeout(function(note) {
                    MIDI.setVolume(0, 127);
                    MIDI.noteOn(0, note["note"], note["velocity"], note["start"]);
                    MIDI.noteOff(0, note["note"], note["end"]);
                }, (1 - note["end"]) * 1000)
            }
            conduct()
        };

        var playNote = function(note) {


        };

        var sleep = function(duration) {
            var now = new Date().getTime();
            while(new Date().getTime() < now + duration){}
        }

    };
</script>
</body>
</html>