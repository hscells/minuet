<DOCTYPE html/>
<html>
<head>
    <title>unnamed music playing bot</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <!-- polyfill -->
    <script src="/static/js/timbre.js" type="text/javascript"></script>
</head>
<body>
<div id="bar-id"></div>
<div id="playing"></div>
<script>
    window.onload = function() {
        var barEl = document.getElementById("bar-id");
        var noteEl = document.getElementById("playing");

        var conduct = function() {
            getBar(function(bar) {
                barEl.innerText = bar["id"];
                playNotes(bar["notes"])
            });
        };

        var getBar = function(callback) {
            var xhr = new XMLHttpRequest();
            xhr.open("get", "/bar", true);
            xhr.responseType = "json";
            xhr.onload = function() {
                var status = xhr.status;
                if (status == 200) {
                    callback(xhr.response)
                }
            };
            xhr.send();
        };

        var playNotes = function(notes) {
            if (notes.length == 0) {
                conduct()
            } else {
                var note = notes[0];
                playNote(note["note"], note["velocity"], note["end"], 0.25, function(synth) {
                    // I think this disposes of the synth object form before
                    synth.allSoundOff();
                    playNotes(notes.slice(1))
                });
            }
        };

        var playNote = function(note, velocity, end, mul, callback) {
            var synth = T("OscGen", {wave:"sin", mul: 1, env:T("perc", {r:(1 - end) * 1000, ar:true})});
            synth.noteOn(note, velocity);
            synth.play().on("ended", function(sythn) {return callback(synth)})
        };

        conduct()

    };
</script>
</body>
</html>